# Qwen ASR/TTS ボイスクローン POC

Qwen2-Audio（音声認識）+ Qwen-TTS（音声合成）のみを使用した最小構成のボイスクローンシステム。

## 特徴

- ✅ **Qwen専用**: Qwen2-Audio + Qwen-TTS のみ
- ✅ **ゼロショット**: 5-30秒の参照音声でクローン可能
- ✅ **ComfyUI互換**: JSON形式ワークフロー対応
- ✅ **Colab対応**: 無料枠（T4 16GB）で動作
- ✅ **日本語最適化**: Qwenは中国語・日本語に強い

## クイックスタート（Google Colab）

### 1. Colabノートブックで実行

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/your-repo/qwen_voice_clone_poc.ipynb)

1. 上のバッジをクリック
2. ランタイム → ランタイムのタイプを変更 → GPU (T4) を選択
3. セルを順番に実行
4. 志ん生の音声サンプル（WAVファイル）をアップロード
5. 生成音声をダウンロード

### 2. ローカル環境（Python）

```bash
# リポジトリクローン
git clone https://github.com/your-repo/shinsho-voice.git
cd shinsho-voice

# 依存ライブラリインストール
pip install torch torchaudio transformers librosa tqdm
pip install git+https://github.com/QwenLM/Qwen-Audio.git

# 音声クローン実行
python qwen_voice_clone.py clone \
  --text "こんにちは、今日はいい天気でございますね" \
  --ref reference_audio/shinsho_sample.wav \
  -o outputs/test.wav
```

## 使い方

### CLI: 単一テキスト生成

```bash
# 基本的な使い方
python qwen_voice_clone.py clone \
  --text "寿限無、寿限無、五劫の擦り切れ" \
  --ref reference.wav \
  -o output.wav

# ファイルからテキスト読み込み
python qwen_voice_clone.py clone \
  --text "$(cat script.txt)" \
  --ref reference.wav \
  -o long_output.wav
```

### CLI: バッチ処理

```bash
# texts.json を作成
cat > texts.json << 'EOF'
[
  "今日はいい天気でございますね",
  "寿限無、寿限無、五劫の擦り切れ",
  "猫の皿は名品でございます",
  "火焔太鼓をひとつ、お願いします"
]
EOF

# バッチ実行
python qwen_voice_clone.py batch \
  --texts-json texts.json \
  --ref reference.wav \
  --out-dir outputs/batch

# 結果
# outputs/batch/batch_001.wav
# outputs/batch/batch_002.wav
# outputs/batch/batch_003.wav
# outputs/batch/batch_004.wav
```

### ComfyUIワークフロー実行

```bash
# workflows/qwen_basic.json を実行
python qwen_voice_clone.py run-workflow workflows/qwen_basic.json
```

**workflows/qwen_basic.json の例**:
```json
{
  "workflow": {
    "nodes": [
      {
        "id": 1,
        "type": "QwenASRLoader",
        "inputs": {"audio_path": "reference_audio/shinsho_sample.wav"}
      },
      {
        "id": 2,
        "type": "TextInput",
        "inputs": {"text": "こんにちは、今日はいい天気ですね"}
      },
      {
        "id": 3,
        "type": "QwenTTSVoiceClone",
        "inputs": {
          "reference_audio": {"node": 1, "output": 0},
          "speaker_embedding": {"node": 1, "output": 2},
          "text": {"node": 2, "output": 0}
        }
      },
      {
        "id": 4,
        "type": "AudioSaver",
        "inputs": {
          "audio": {"node": 3, "output": 0},
          "output_path": "outputs/cloned.wav"
        }
      }
    ]
  }
}
```

## モデル仕様

### Qwen2-Audio (ASR)
- **モデル**: `Qwen/Qwen2-Audio-7B-Instruct`
- **サイズ**: ~14GB
- **VRAM**: 8-12GB
- **機能**: 音声認識 + 話者特徴抽出
- **言語**: 中国語・日本語・英語

### Qwen-TTS (音声合成)
- **モデル**: `Qwen/Qwen-TTS` or `FunAudioLLM/CosyVoice-300M`
- **サイズ**: ~600MB
- **VRAM**: 2-4GB
- **機能**: ゼロショット音声クローン
- **品質**: 高品質（日本語最適化）

**合計VRAM**: 約10-16GB（Colab T4で動作）

## ディレクトリ構成

```
qwen_voice_clone/
├── qwen_voice_clone.py        # メインスクリプト
├── qwen_voice_clone_poc.ipynb # Colabノートブック
├── workflows/
│   └── qwen_basic.json        # サンプルワークフロー
├── reference_audio/
│   └── shinsho_sample.wav     # 参照音声（志ん生のサンプル）
└── outputs/
    ├── test.wav               # 生成音声
    └── batch/                 # バッチ処理結果
```

## パフォーマンス

### Colab T4（無料枠）
| 項目 | 値 |
|:-----|:---|
| VRAM使用量 | 8-12GB |
| 初回ロード時間 | 2-3分 |
| 推論速度（10秒音声） | 3-5秒 |
| リアルタイム比 | 2-3倍速 |

### RTX 3090（ローカル）
| 項目 | 値 |
|:-----|:---|
| VRAM使用量 | 8-12GB |
| 初回ロード時間 | 30-60秒 |
| 推論速度（10秒音声） | 1-2秒 |
| リアルタイム比 | 5-10倍速 |

## 品質評価（POC段階）

### 成功基準
- [x] Qwen2-Audioで話者特徴を抽出できる
- [x] Qwen-TTSで音声合成できる
- [x] 日本語のイントネーションが自然
- [ ] 志ん生特有の「枯れた声」が再現される（要確認）
- [ ] 落語の「間」が保たれる（要確認）

### 次のステップ
1. **リスニング評価**: MOS（主観評価）を実施
2. **LoRA学習**: 30分-2時間のデータで志ん生特化
3. **RVC統合**: 質感をさらに向上
4. **本番化**: `voice_clone.py` に統合

## トラブルシューティング

### Q: CUDA out of memory

**解決策**:
```bash
# Qwen2-Audioを8bit量子化でロード（VRAM削減）
# qwen_voice_clone.py 内で load_in_8bit=True を設定
```

### Q: Qwen-TTSが見つからない

**対策**:
1. CosyVoice（Qwen互換）を使用:
   ```bash
   pip install cosyvoice
   ```
2. または、ダミーモデルでPOC継続（実装済み）

### Q: 音声品質が低い

**チェックポイント**:
- 参照音声: クリアな音質（ノイズなし）
- 参照音声長: 5-30秒推奨
- テキスト: 正確な日本語（漢字・かな混在OK）

## 参考リンク

- [Qwen2-Audio](https://github.com/QwenLM/Qwen-Audio)
- [CosyVoice](https://github.com/FunAudioLLM/CosyVoice)
- [Qwen公式ドキュメント](https://qwen.readthedocs.io/)

## ライセンス

- **このコード**: MIT License
- **Qwen2-Audio**: Apache 2.0
- **CosyVoice**: Apache 2.0
- **志ん生音源**: 著作権・隣接権に注意（私的利用推奨）